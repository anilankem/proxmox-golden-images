name: Build Rocky 9 Golden Image

on:
  workflow_dispatch:

env:
  VMID: "9002"
  NODE: "proxmox"

jobs:
  build:
    runs-on: self-hosted

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # Ensure tools exist
    - name: Ensure Packer and jq
  run: |
    # Install jq if missing
    command -v jq >/dev/null 2>&1 || sudo apt update && sudo apt install -y jq

    # Install / Upgrade Packer if version < 1.14
    PACKER_VERSION=$(packer version | head -1 | awk '{print $2}' | tr -d 'v')
    REQUIRED="1.14.3"

    if [ "$(printf '%s\n' "$REQUIRED" "$PACKER_VERSION" | sort -V | head -n1)" != "$REQUIRED" ]; then
      echo "Upgrading Packer..."
      curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
      sudo apt-add-repository "deb https://apt.releases.hashicorp.com $(lsb_release -cs) main"
      sudo apt update
      sudo apt install -y packer
    fi

    packer version
    jq --version


      # Cleanup old VM
      - name: Cleanup existing VM
        run: |
          STATUS=$(curl -s -k \
            -H "Authorization: PVEAPIToken=${{ secrets.PROXMOX_TOKEN_ID }}=${{ secrets.PROXMOX_TOKEN_SECRET }}" \
            ${{ secrets.PROXMOX_URL }}/nodes/${NODE}/qemu/${VMID}/status/current \
            | jq -r '.data.status' 2>/dev/null || echo "notfound")

          if [ "$STATUS" != "notfound" ] && [ "$STATUS" != "null" ]; then
            echo "VM exists. Removing..."
            curl -s -k -X POST \
              -H "Authorization: PVEAPIToken=${{ secrets.PROXMOX_TOKEN_ID }}=${{ secrets.PROXMOX_TOKEN_SECRET }}" \
              ${{ secrets.PROXMOX_URL }}/nodes/${NODE}/qemu/${VMID}/status/stop || true
            sleep 8
            curl -s -k -X DELETE \
              -H "Authorization: PVEAPIToken=${{ secrets.PROXMOX_TOKEN_ID }}=${{ secrets.PROXMOX_TOKEN_SECRET }}" \
              ${{ secrets.PROXMOX_URL }}/nodes/${NODE}/qemu/${VMID}
          fi

      - name: Packer Init
        run: packer init rocky.pkr.hcl

      - name: Packer Validate
        env:
          PKR_VAR_proxmox_url: ${{ secrets.PROXMOX_URL }}
          PKR_VAR_token_id: ${{ secrets.PROXMOX_TOKEN_ID }}
          PKR_VAR_token_secret: ${{ secrets.PROXMOX_TOKEN_SECRET }}
        run: packer validate rocky.pkr.hcl

      - name: Packer Build
        env:
          PKR_VAR_proxmox_url: ${{ secrets.PROXMOX_URL }}
          PKR_VAR_token_id: ${{ secrets.PROXMOX_TOKEN_ID }}
          PKR_VAR_token_secret: ${{ secrets.PROXMOX_TOKEN_SECRET }}
        run: packer build rocky.pkr.hcl

      # Verify VM is stopped
      - name: Verify VM stopped
        run: |
          STATE=$(curl -s -k \
            -H "Authorization: PVEAPIToken=${{ secrets.PROXMOX_TOKEN_ID }}=${{ secrets.PROXMOX_TOKEN_SECRET }}" \
            ${{ secrets.PROXMOX_URL }}/nodes/${NODE}/qemu/${VMID}/status/current \
            | jq -r '.data.status')

          echo "VM state: $STATE"
          [ "$STATE" = "stopped" ]

      # ðŸ”¥ Convert VM to Template
      - name: Convert to Template
        run: |
          curl -s -k -X POST \
            -H "Authorization: PVEAPIToken=${{ secrets.PROXMOX_TOKEN_ID }}=${{ secrets.PROXMOX_TOKEN_SECRET }}" \
            ${{ secrets.PROXMOX_URL }}/nodes/${NODE}/qemu/${VMID}/template

      # âœ… Validate template flag
      - name: Validate Template
        run: |
          TEMPLATE=$(curl -s -k \
            -H "Authorization: PVEAPIToken=${{ secrets.PROXMOX_TOKEN_ID }}=${{ secrets.PROXMOX_TOKEN_SECRET }}" \
            ${{ secrets.PROXMOX_URL }}/nodes/${NODE}/qemu/${VMID}/status/current \
            | jq -r '.data.template')

          echo "Template flag: $TEMPLATE"

          if [ "$TEMPLATE" != "true" ]; then
            echo "Template conversion failed!"
            exit 1
          fi

          echo "âœ… Rocky Golden Template Ready!"
