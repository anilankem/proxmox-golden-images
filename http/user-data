#cloud-config
autoinstall:
  version: 1
  locale: en_US.UTF-8
  
  keyboard:
    layout: us

  # 'interactive-sections' controls if the installer stops to ask questions.
  # Set to [] (empty list) for fully automated.
  interactive-sections: []

  ssh:
    install-server: true
    allow-pw: true

  identity:
    hostname: ubuntu24-golden
    username: ubuntu
    # Password: "ubuntu" (example hash)
    password: "$6$gXvGGLYtBfU1cvyO$pRaGMuhKRB1XUQKszal3NbVoIJhf6UBSP482005KLbvlkXiVEMGp9eiqV78E3R5gCqxDv1kzraD3q86kfeDIE/"

  storage:
    layout:
      name: lvm

  packages:
    - qemu-guest-agent
    # Removed: sudo, cloud-init, openssh-server (these are installed by default)

  late-commands:
    # 1. Set root password
    # FIX: Use pipe (|) instead of here-string (<<<) to ensure compatibility with 'sh'
    - "echo 'root:anilankem' | curtin in-target --target=/target -- chpasswd"

    # 2. Enable Root SSH Login
    # FIX: Use -r to handle regex metacharacters properly if needed, and -- to separate args
    - "curtin in-target --target=/target -- sed -i 's/^#\\?PermitRootLogin.*/PermitRootLogin yes/g' /etc/ssh/sshd_config"
    
    # 3. Enable Password Authentication (Backup measure, usually enabled by default in 'allow-pw: true')
    - "curtin in-target --target=/target -- sed -i 's/^#\\?PasswordAuthentication.*/PasswordAuthentication yes/g' /etc/ssh/sshd_config"

    # 4. Enable QEMU Agent (and start it immediately if possible, though mostly for next boot)
    - "curtin in-target --target=/target -- systemctl enable qemu-guest-agent"